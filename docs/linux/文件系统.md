---
editLink: false
---

# 文件系统

## 文件系统特性
微软操作系统的主要文件系统是FAT（FAT16）、NTFS这些文件格式
Linux正统文件系统为Ext2。默认情况下，windows操作系统识别不了Linux的Ext2
在传统的磁盘与文件系统的应用中，一个分区槽就是只能被格式化成为一个系统文件。一个filesystem就是一个partition。
新技术中，LVM与软件磁盘阵列，可以将一个分区槽格式化为多个系统文件。也能够将多个分区槽合成一个文件系统（LVM、RAID）。
所有，通常一个被挂载的数据为一个文件系统而不是一个分区槽。

文件系统通常会将这两部分的数据分别存放在不同区块，权限与属性放置到`inode`中，实际数据则放置到`data block`区块中。还有一个超级区块（superblock）会记录整个文件系统的整体信息，包括`inode`与`block`的总量、使用量、剩余量。
- superblock: 记录此filesystem的整体信息，包括inode/block的总量、使用量、剩余量，以及文件系统的格式与相关信息等
- inode： 记录文件属性，一个文件占用一个inode，同时记录此文件的数据所在的block号码
- block： 实际记录文件的内容，若文件太大时，会占用多个block
inode与block都有编号，每一个文件都会占用一个inode，inode内则有文件数据放置的block号码。

  inode与block也称索引式文件系统
## linux的EXT2文件系统（inode）
文件系统一开始就将inode与block规划好了，除非重新格式化（或者利用resize2fs等指令变更文件系统大小），否则inode与block固定后就不再变动。
Ext2文件系统在格式化的时候基本上是区分为多个区块群组（block group）的，每个区块群组都有独立的inode/block/superblock系统。
文件系统最前面有一个启动扇区（boot sector），这个启动扇区可以安装开机管理程序。

每一个block group有一下内容

superblock、档案系统描述、区块对照表、Inode对照表、Inode Table、 Data Block

### data block（资料区块）

data block 是用来放置文件内容数据地方，在Ext2文件系统中所支持的block大小有1K、2K及4K三种。在格式化时block的大小就固定了，且每个block都有编号，方便inode的记录。
|Block大小|1KB|2KB|4KB|
|---|---|---|---|
|最大单一文件限制|16GB|256GB|2TB|
|最大文件系统总容量|2TB|8TB|16TB|

基本限制：
- 原则上，block的大小与数量在格式化完就不能够再改变了
- 每个block内最多只能放置一个文件的数据
- 如果文件大于block的大小，则一个文件会占用多个block数量
- 若文件小于block，则该block的剩余容量就不能够再被使用了

### inode table（inode 表）
- 文件的存取模式（read/write/excute）
- 文件的拥有者与群组（owner/group）
- 文件的容量
- 文件建立或状态改变的时间（ctime）
- 最近一次的读取时间（atime）
- 最近修改的时间（mtime）
- 定义文件特性的flag。（SetUID）
- 该文件真正内容的指向（pointer）
inode的数量与大小也是格式化时就已经固定了
- 每一个inode大小均固定为128bytes（新的ext4与xfs可设定到256bytes）
- 每个文件都仅会占用一个inode
- 文件系统能够建立的文件数量与inode的数量有关
- 系统读取文件时需要先找到inode，并分析inode所记录的权限与用户是否符合，若符合才能够开始实际读取block的内容

inode仅有128bytes，而inode记录一个block号码要使用4byte。若一个文件为400MB且每个block为4K，那么至少也需要许多block号码的记录。inode没法记录这么多的信息。因此，inode记录block号码的区域定义为12个直接、一个间接，一个双间接与一个三间接记录区。
间接就是一个block来当作记录block号码的记录取，如果文件太大时，就会使用间接的block来记录编号。

  inode能够指定多少个block呢 以1K block来说
  - 12 个直接指向： 12 \* 1K = 12K
    由于是直接指向，所以总共可记录12笔记录
  - 间接： 256 \*　1K = 256K
    每笔block号码的记录会花去4bytes，因此1K的大小能够记录256笔记录
  - 双间接： 256\*256\*1K = 256^2K
    第一层block会指定256个第二层，每个第二层可以指定256个号码
  - 三间接： 256 \* 256 \* 256 \* 1K = 256^3K
    第一层block会指定256个第二层，每个第二层可以指定256个第三层，每个第三层可以指定256个号码
  - 总额: 将直接、间接、双间接、三间接加总，得到 12 + 256 + 256 \* 256 +　256\*256\*256(K) = 16GB 
  但是2K和4Kblock大小的计算中，不能使用这个方法，因为大于2K的block将会受到Ext2文件系统本身的限制、所有计算的结果会不符合。
  Ext4文件系统的inode容量已经可以扩大到256bytes。
### Superblock（超级区块）
  Superblock是记录整个filesystem相关信息的地方，没有Superblock，就没有filesystem，这个文件系统的基本信息都在这呢。
  记录的主要信息有：
  - block与inode的总量
  - 未使用与已使用的inode/block数量
  - block与inode的大小（block为1、2、4K，inode为128bytes或256bytes）
  - filesystem的挂载时间、最近一次写入数据的时间、最近一次检验磁盘（fsck）的时间等文件系统的相关信息
  - 一个valid bit 数值，若此文件系统已被挂载，则valid bit为0， 若未被挂载，则valid bit 为1

  superblock的大小为1024bytes，相关的superblock信息都会以`dumpe2fs`指令来观察

### Filesystem Description（文件系统描述说明）
可以描述每个block group的开始与结束的block号码，以及说明每个区段（superblock，bitmap，inodemap，data block）分别介于哪一个block号码之间。这也能够用`dumpe2fs`来观察
### block bitmap（区块对照表）
记录哪些是被占用的block，哪些是被删出的block--映射
